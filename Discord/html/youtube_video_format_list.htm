<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Download video</title>
<link href="css/common.css" rel="stylesheet" type="text/css" />

<script type="text/javascript">
var audio_url="";
function addRow(text,url)
{
	var list=document.getElementById("youtube-video-format-list");
	if(list)
	{
		var option = document.createElement("option")
		option.appendChild(document.createTextNode(text));
		option.value = url;
		list.appendChild(option);

		list.size += 1;
	}
}

function Get1080pVideoAudioLinks(formats)
{
	if (formats=="") return "";
	var links=formats.split(",");
	var video_url="";
	for(var i=0;i<links.length;i++)
	{
		var link = links[i];
		var sQuality=GetParamValue(link,"quality_label");
		var sType=GetParamValue(link,"type");
		var clen=GetParamValue(link,"clen");	
		var url=GetParamValue(link,"url");
		
		if (sQuality=="1080p" && sType.indexOf("video/mp4")==0) 
		{
			video_url=url;
		}
		if (sType.indexOf("audio/mp4")==0)
		{
			audio_url=url;
		}
	}
	if (video_url!="" && audio_url!="") return video_url+","+audio_url;
	return "";
}

function GetParamValue(sParameters,sParamName)
{
	sParameters='&'+sParameters;
	var p=sParameters.toLowerCase().indexOf('&'+sParamName.toLowerCase()+'=');
	if (p==-1) return "";
	p=p+sParamName.length+2;
	var pe=sParameters.indexOf('&',p);
	if (pe==-1) pe=sParameters.length;
	return unescape(sParameters.substr(p,pe-p));
}

function PopulateFormatList(sFormats,sAdaptiveFormats)
{
	sFormats=sFormats.replace(/\\u0026/g,"&");
	sAdaptiveFormats=sAdaptiveFormats.replace(/\\u0026/g,"&");
	var list=document.getElementById("youtube-video-format-list");
	
	var link_1080p=Get1080pVideoAudioLinks(sAdaptiveFormats);
	if (link_1080p!="")
	{
		var video_url=link_1080p.split(",")[0];
		var clen=GetParamValue(video_url,"clen");
		var label="1080p,video/mp4";
		if (clen!="") label+=" ("+Math.round(clen/1024/1024)+"MB)";
		addRow(label,link_1080p,"mp4");
	}		
	
	var links=new Array();
	if (sFormats!="")
	{
		links=sFormats.split(",");
		for(var i=0;i<links.length;i++){
			var link = links[i];
			var sQuality=GetParamValue(link,"quality");
			var sType=GetParamValue(link,"type");
			var sUrl=GetParamValue(link,"url");
			var clen=GetParamValue(sUrl,"clen");
			var sig=GetParamValue(link,"sig");


			if (sQuality=="") continue;
			if (sQuality=="small") sQuality="Low Quality";
			else if (sQuality=="medium") sQuality="360p";
			else if (sQuality=="large") sQuality="480p";
			else if (sQuality=="hd720") sQuality="720p";

			var p=sType.indexOf(";");
			if (p==-1) p=sType.length;
			
			if (GetParamValue(sUrl,"signature")=="" && GetParamValue(sUrl,"sig")=="")
			{
				if (sig!="") sUrl += "&signature=" + sig;
				else return 0;	//Abort if no valid sigature found.
			}

			var pos=sType.indexOf("/")+1;
			if (pos==-1) pos=sType.length();
			var sExt=sType.substring(pos,p);
			if (sExt=="x-flv") sExt="flv";
			else if (sExt=="3gpp") sExt="3gp";
			sType=sType.substring(0,p);
		
			var label=sQuality+","+sType;
			if (clen!="") label+=" ("+Math.round(clen/1024/1024)+"MB)";
			addRow(label,sUrl,sExt);
		}
	}
	return links.length+ (link_1080p!="");
}


function OnDownloadVideoClicked()
{
	var index = document.getElementById("youtube-video-format-list").selectedIndex;
	var url = document.getElementById("youtube-video-format-list").options[index].value;
	document.sjReturnValue="download_video "+url;
	window.close();
}


function OnDownloadAudioClicked()
{
	document.sjReturnValue="download_audio "+audio_url;
	window.close();
}

</script>
</head>
<body style="font-size:13px; font-family:Verdana, Geneva, sans-serif">
<div style="width:400px">
 <p style="margin-top:20px; margin-bottom:0px">Available formats:</p>
 <table width="100%" border="0">
   <tr>
     <td width="240">
     	<select id="youtube-video-format-list" size="6" style="height:180px; width:240px; margin-top:5px; margin-bottom:5px;"></select>
       <label><br />
       </label></td>
     <td valign="center" align="center">
     	<p style="margin-bottom:20px"><input type="button" name="download_video" value="Download video" style="width:150px" onclick="OnDownloadVideoClicked()"/></p>
       <p style="margin-bottom:20px"><input type="button" name="download_audio" value="Download audio" style="width:150px" onclick="OnDownloadAudioClicked()"/></p>
       <p style="margin-bottom:20px"><input type="button" name="cancel" value="Cancel" style="width:150px" onclick="window.close()"/></p>
       <p style="margin-bottom:20px"><input type="button" name="help" value="Help" style="width:150px" onclick="location.href='sjcmd://viewhelp youtube-video-downloader'"/></p>
</td>
   </tr>
 </table>
</div>
</body>
</html>
